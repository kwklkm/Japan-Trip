<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å»£å³¶è¦ªå­å†¬æ—¥è‡ªé§•éŠ Dashboard + AI + ç·¨è¼¯</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Markdown Parser for AI responses -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* Custom Font Import */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f5f5f4; /* stone-100 */
        }

        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }

        /* Hide scrollbar for clean horizontal scrolling */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .btn-active {
            background-color: #d97706; /* amber-600 */
            color: white;
            border-color: #d97706;
        }

        /* Chat UI Styles */
        .chat-bubble {
            max-width: 80%;
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 8px;
            word-wrap: break-word;
        }
        .user-msg {
            background-color: #d97706;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 2px;
        }
        .ai-msg {
            background-color: #f3f4f6;
            color: #1f2937;
            align-self: flex-start;
            border-bottom-left-radius: 2px;
            border: 1px solid #e5e7eb;
        }
        .ai-msg p { margin-bottom: 0.5em; }
        .ai-msg ul { list-style-type: disc; padding-left: 1.2em; margin-bottom: 0.5em; }
        .typing-dot {
            display: inline-block;
            width: 6px;
            height: 6px;
            margin-right: 3px;
            background-color: #9ca3af;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* Edit Mode Styles */
        .edit-input {
            border: 1px solid #d6d3d1;
            padding: 4px 8px;
            border-radius: 4px;
            width: 100%;
            font-size: 0.9rem;
            margin-bottom: 4px;
        }
        .edit-input:focus {
            outline: none;
            border-color: #d97706;
            box-shadow: 0 0 0 2px rgba(217, 119, 6, 0.2);
        }
    </style>
    <!-- Chosen Palette: Warm Neutrals (Stone/Amber/Teal) -->
    <!-- Application Structure Plan: 
         Updated with Edit Functionality in Itinerary View.
         - Added "Edit Mode" toggle.
         - Uses LocalStorage to persist changes.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
</head>
<body class="text-stone-800">

    <!-- App Container -->
    <div class="max-w-4xl mx-auto min-h-screen bg-white shadow-xl overflow-hidden flex flex-col relative">

        <!-- Header -->
        <header class="bg-stone-800 text-stone-100 p-6">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold tracking-wide">å»£å³¶å†¬æ—¥è¦ªå­è‡ªé§•å†’éšª</h1>
                    <p class="text-stone-400 mt-1">12æœˆ26æ—¥ - 12æœˆ31æ—¥ | 6å¤©5å¤œ</p>
                </div>
                <div class="mt-4 md:mt-0 flex gap-2">
                    <button onclick="resetData()" class="text-xs text-stone-500 underline hover:text-stone-300 mr-2">æ¢å¾©é è¨­å€¼</button>
                    <span class="bg-stone-700 px-3 py-1 rounded-full text-xs">ğŸš— å…¨ç¨‹è‡ªé§•</span>
                    <span class="bg-stone-700 px-3 py-1 rounded-full text-xs">ğŸ¨ b hotel ã‚¢ãƒ¼ãƒ„åœŸæ©‹</span>
                </div>
            </div>
            <div class="mt-6 grid grid-cols-4 gap-2 text-center text-sm">
                <div class="bg-stone-700 rounded p-2">
                    <div class="font-bold text-amber-400">ğŸ‘¨ çˆ¸çˆ¸</div>
                    <div class="text-xs text-stone-300">ç¾é£Ÿæ“”ç•¶</div>
                </div>
                <div class="bg-stone-700 rounded p-2">
                    <div class="font-bold text-rose-400">ğŸ‘© åª½åª½</div>
                    <div class="text-xs text-stone-300">è³¼ç‰©/ç¾æ‹</div>
                </div>
                <div class="bg-stone-700 rounded p-2">
                    <div class="font-bold text-sky-400">ğŸ‘¦ 13æ­²</div>
                    <div class="text-xs text-stone-300">è»è‰¦/æ¨¡å‹</div>
                </div>
                <div class="bg-stone-700 rounded p-2">
                    <div class="font-bold text-sky-400">ğŸ‘¶ 9æ­²</div>
                    <div class="text-xs text-stone-300">é‡£é­š/è»Šè»Š</div>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="flex overflow-x-auto no-scrollbar border-b border-stone-200 bg-stone-50 sticky top-0 z-10">
            <button onclick="switchTab('itinerary')" id="tab-itinerary" class="flex-1 py-4 px-6 font-semibold text-stone-600 hover:text-amber-600 border-b-4 border-transparent focus:outline-none whitespace-nowrap btn-active transition-colors duration-300">
                ğŸ“… æ¯æ—¥è¡Œç¨‹
            </button>
            <button onclick="switchTab('analysis')" id="tab-analysis" class="flex-1 py-4 px-6 font-semibold text-stone-600 hover:text-amber-600 border-b-4 border-transparent focus:outline-none whitespace-nowrap transition-colors duration-300">
                ğŸ“Š è¡Œç¨‹åˆ†æ
            </button>
            <button onclick="switchTab('food')" id="tab-food" class="flex-1 py-4 px-6 font-semibold text-stone-600 hover:text-amber-600 border-b-4 border-transparent focus:outline-none whitespace-nowrap transition-colors duration-300">
                ğŸ± å¿…åƒæ¸…å–®
            </button>
            <button onclick="switchTab('tips')" id="tab-tips" class="flex-1 py-4 px-6 font-semibold text-stone-600 hover:text-amber-600 border-b-4 border-transparent focus:outline-none whitespace-nowrap transition-colors duration-300">
                ğŸ“ æ”»ç•¥èˆ‡è²¼å£«
            </button>
        </nav>

        <!-- Main Content Area -->
        <main class="flex-grow p-4 md:p-6 bg-stone-50 overflow-y-auto pb-24">

            <!-- VIEW: ITINERARY -->
            <div id="view-itinerary" class="fade-in block">
                <div class="bg-white rounded-lg shadow-sm p-4 mb-6 border-l-4 border-amber-500 flex justify-between items-start">
                    <div>
                        <h2 class="text-lg font-bold text-stone-800 mb-2">è¡Œç¨‹æ¢ç´¢æŒ‡å—</h2>
                        <p class="text-stone-600 text-sm">
                            é»æ“Šæ—¥æœŸå¡ç‰‡æŸ¥çœ‹å®‰æ’ã€‚é»æ“Šå³å´ã€Œç·¨è¼¯ã€æŒ‰éˆ•å¯ä¿®æ”¹è¡Œç¨‹å…§å®¹ï¼Œæ‰€æœ‰ä¿®æ”¹æœƒè‡ªå‹•å„²å­˜ã€‚
                        </p>
                    </div>
                    <button id="edit-toggle-btn" onclick="toggleEditMode()" class="bg-stone-100 text-stone-600 px-3 py-1 rounded border border-stone-300 hover:bg-amber-100 hover:text-amber-700 hover:border-amber-400 transition-colors text-sm font-bold flex items-center gap-1">
                        âœï¸ ç·¨è¼¯è¡Œç¨‹
                    </button>
                </div>

                <!-- Day Selector -->
                <div class="flex overflow-x-auto gap-3 pb-4 mb-2 no-scrollbar" id="day-selector">
                    <!-- JS will populate buttons -->
                </div>

                <!-- Active Day Details -->
                <div id="day-details-container" class="space-y-4">
                    <!-- JS will populate details -->
                </div>
            </div>

            <!-- VIEW: ANALYSIS -->
            <div id="view-analysis" class="hidden fade-in">
                <div class="bg-white rounded-lg shadow-sm p-4 mb-6 border-l-4 border-purple-500">
                    <h2 class="text-lg font-bold text-stone-800 mb-2">å®¶åº­èˆˆè¶£å¹³è¡¡åˆ†æ</h2>
                    <p class="text-stone-600 text-sm">
                        é€™æ˜¯ä¸€å€‹æ»¿è¶³æ‰€æœ‰äººçš„è¡Œç¨‹å—ï¼Ÿæˆ‘å€‘é€šéæ•¸æ“šè¦–è¦ºåŒ–ä¾†åˆ†æé€™æ¬¡æ—…è¡Œçš„æ§‹æˆã€‚
                    </p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Radar Chart -->
                    <div class="bg-white p-4 rounded-xl shadow border border-stone-100">
                        <h3 class="font-bold text-center mb-4 text-stone-700">èˆˆè¶£æ»¿æ„åº¦åˆ†ä½ˆ</h3>
                        <div class="chart-container">
                            <canvas id="interestChart"></canvas>
                        </div>
                        <p class="text-xs text-center text-stone-400 mt-2">åŸºæ–¼æ™¯é»å±¬æ€§èˆ‡åœç•™æ™‚é–“æ¬Šé‡</p>
                    </div>

                    <!-- Pie Chart -->
                    <div class="bg-white p-4 rounded-xl shadow border border-stone-100">
                        <h3 class="font-bold text-center mb-4 text-stone-700">æ´»å‹•é¡å‹ä½”æ¯”</h3>
                        <div class="chart-container">
                            <canvas id="activityChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Highlights Summary -->
                <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-sky-50 p-4 rounded-lg border border-sky-100">
                        <h4 class="font-bold text-sky-800 mb-2">ğŸ‘¦ ç”·å­©å€‘çš„æ”¶ç©«</h4>
                        <ul class="list-disc list-inside text-sm text-sky-700 space-y-1">
                            <li>çœŸå¯¦æ½›æ°´è‰‡å…§éƒ¨æ¢ç´¢ (å³å¸‚)</li>
                            <li>äº¤é€šç§‘å­¸åšç‰©é¤¨æ¨¡å‹èˆ‡è®Šå½¢å–®è»Š</li>
                            <li>å±±æ³‰æ°´é‡£é­šé«”é©—èˆ‡ç¾çƒ¤é®®é­š</li>
                            <li>å®®å³¶æ°´æ—é¤¨çš„æ±Ÿè±šèˆ‡æµ·æ´‹ç”Ÿç‰©</li>
                        </ul>
                    </div>
                    <div class="bg-rose-50 p-4 rounded-lg border border-rose-100">
                        <h4 class="font-bold text-rose-800 mb-2">ğŸ‘© åª½åª½çš„æ™‚å…‰</h4>
                        <ul class="list-disc list-inside text-sm text-rose-700 space-y-1">
                            <li>THE OUTLETS HIROSHIMA å¤§å‹è³¼ç‰©</li>
                            <li>æœ¬é€šå•†åº—è¡—è—¥å¦èˆ‡é›œè²¨æƒè²¨</li>
                            <li>SOGO/Parco å¹´æœ«æŠ˜æ‰£å­£</li>
                            <li>å®®å³¶è¡¨åƒé“æ•£ç­–</li>
                        </ul>
                    </div>
                    <div class="bg-amber-50 p-4 rounded-lg border border-amber-100">
                        <h4 class="font-bold text-amber-800 mb-2">ğŸ‘¨ çˆ¸çˆ¸çš„ç¾é£Ÿ</h4>
                        <ul class="list-disc list-inside text-sm text-amber-700 space-y-1">
                            <li>å»£å³¶ç‡’ååº—å·¡ç¦®</li>
                            <li>å³å¸‚æ­£å®—æµ·è»å’–å“©</li>
                            <li>å®®å³¶æ˜Ÿé°»é£¯ (ç©´å­é£¯)</li>
                            <li>å†¬å­£é™å®šè ”å°å±‹ç‚­çƒ¤ç‰¡è £</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- VIEW: FOOD -->
            <div id="view-food" class="hidden fade-in">
                <div class="bg-white rounded-lg shadow-sm p-4 mb-6 border-l-4 border-amber-600 flex justify-between items-center">
                    <div>
                        <h2 class="text-lg font-bold text-stone-800 mb-1">å»£å³¶å¿…åƒç¾é£Ÿæ¸…å–®</h2>
                        <p class="text-stone-600 text-sm">é€™æ˜¯ç‚ºçˆ¸çˆ¸ç‰¹åˆ¥æº–å‚™çš„ä»»å‹™æ¸…å–®ï¼</p>
                    </div>
                    <button onclick="triggerAIChat('è«‹æ¨è–¦å»£å³¶é©åˆè¦ªå­ç”¨é¤çš„é¤å»³ï¼Œç‰¹åˆ¥æ˜¯æœ‰æä¾›å…’ç«¥é¤å…·å’Œä¸è¾£é¸é …çš„åº—å®¶ã€‚')" class="bg-amber-100 text-amber-700 px-3 py-1 rounded-full text-xs font-bold hover:bg-amber-200 transition-colors">
                        âœ¨ AI æ¨è–¦æ›´å¤šç¾é£Ÿ
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="food-list-container">
                    <!-- JS will populate -->
                </div>
            </div>

            <!-- VIEW: TIPS -->
            <div id="view-tips" class="hidden fade-in">
                <div class="bg-white rounded-lg shadow-sm p-4 mb-6 border-l-4 border-emerald-500 flex justify-between items-center">
                    <div>
                        <h2 class="text-lg font-bold text-stone-800 mb-1">è‡ªé§•èˆ‡å†¬å­£æ”»ç•¥</h2>
                        <p class="text-stone-600 text-sm">å¹´æœ«æ—…éŠéœ€è¦ç‰¹åˆ¥æ³¨æ„è¨­æ–½ç‡Ÿæ¥­æ™‚é–“ã€‚</p>
                    </div>
                    <button onclick="triggerAIChat('è«‹å¹«æˆ‘ç”Ÿæˆä¸€æ®µæ—¥æ–‡ï¼Œå…§å®¹æ˜¯å‘é¤å»³é è¨‚12æœˆ30æ—¥æ™šä¸Š7é»ï¼Œ2å¤§2å°ï¼Œéœ€è¦å…’ç«¥æ¤…ã€‚')" class="bg-emerald-100 text-emerald-700 px-3 py-1 rounded-full text-xs font-bold hover:bg-emerald-200 transition-colors">
                        âœ¨ AI ç”Ÿæˆæ—¥æ–‡è¨‚ä½æ–‡å­—
                    </button>
                </div>

                <div class="space-y-4">
                    <!-- Tip Card 1 -->
                    <div class="bg-white border border-stone-200 rounded-lg p-5">
                        <div class="flex items-start gap-3">
                            <span class="text-2xl">âš ï¸</span>
                            <div>
                                <h3 class="font-bold text-stone-800">å¹´æœ«å¹´å§‹ä¼‘é¤¨æ³¨æ„</h3>
                                <p class="text-sm text-stone-600 mt-1">12æœˆ29æ—¥æ˜¯åˆ†ç•Œç·šã€‚è¨±å¤šå…¬ç«‹åšç‰©é¤¨ï¼ˆå¦‚é¦¬è‡ªé”åšç‰©é¤¨ã€åœ–æ›¸é¤¨ï¼‰æœƒåœ¨æ­¤æ™‚é–‹å§‹æ”¾å¹´å‡ã€‚</p>
                                <ul class="mt-2 text-xs bg-red-50 text-red-700 p-2 rounded">
                                    <li>é¦¬è‡ªé”åšç‰©é¤¨ï¼šé è¨ˆ 12/27-1/5 ä¼‘é¤¨ (è¡Œç¨‹å·²é¿é–‹)</li>
                                    <li>å¤§å’Œåšç‰©é¤¨ï¼šæœ¬é¤¨æ•´ä¿®ä¸­ï¼Œè«‹å°èˆªè‡³ã€Œè¡›æ˜Ÿå±•é¤¨ã€</li>
                                    <li>é™¤å¤• (12/31)ï¼šç™¾è²¨å…¬å¸ç´„ 18:00 ææ—©æ‰“çƒŠ</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Tip Card 2 -->
                    <div class="bg-white border border-stone-200 rounded-lg p-5">
                        <div class="flex items-start gap-3">
                            <span class="text-2xl">ğŸ§¥</span>
                            <div>
                                <h3 class="font-bold text-stone-800">å†¬å­£ç©¿è‘—å»ºè­° (2Â°C - 10Â°C)</h3>
                                <p class="text-sm text-stone-600 mt-1">æµ·é‚Šé¢¨å¤§ï¼Œé«”æ„Ÿæº«åº¦æœƒæ›´ä½ã€‚</p>
                                <div class="mt-3 grid grid-cols-2 gap-2 text-xs">
                                    <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-blue-400"></span> é˜²é¢¨åšå¤–å¥— (å¿…å‚™)</div>
                                    <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-blue-400"></span> æ‰‹å¥—/åœå·¾ (é‡£é­š/ä¹˜èˆ¹æ™‚)</div>
                                    <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-blue-400"></span> æš–æš–åŒ…</div>
                                    <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-blue-400"></span> èˆ’é©å¥½èµ°çš„é‹</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tip Card 3 -->
                    <div class="bg-white border border-stone-200 rounded-lg p-5">
                        <div class="flex items-start gap-3">
                            <span class="text-2xl">ğŸ…¿ï¸</span>
                            <div>
                                <h3 class="font-bold text-stone-800">è‡ªé§•åœè»Šæ”»ç•¥</h3>
                                <p class="text-sm text-stone-600 mt-1">å¸‚å€åœè»Šè²»æ˜‚è²´ï¼Œå–„ç”¨ "æœ€å¤§æ–™é‡‘"ã€‚</p>
                                <ul class="mt-2 text-sm text-stone-600 list-disc list-inside">
                                    <li>å°‹æ‰¾æ¨™ç¤ºã€Œå¤œé–“æœ€å¤§æ–™é‡‘ã€çš„åœè»Šå ´éå¤œã€‚</li>
                                    <li>å»ºè­°ä½¿ç”¨ Google Maps æ¨™è¨˜é£¯åº—é™„è¿‘çš„ Times æˆ– Reparkã€‚</li>
                                    <li>å®®å³¶å£æ­èˆ¹è™•æœ‰å¤§å‹åœè»Šå ´ï¼Œä½†åœ¨å‡æœŸä¸Šåˆå®¹æ˜“å®¢æ»¿ï¼Œå»ºè­°ææ—©å‡ºç™¼ã€‚</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </main>

        <!-- Floating Action Button for AI Assistant -->
        <button onclick="toggleAIChat()" class="fixed bottom-6 right-6 bg-stone-800 hover:bg-stone-700 text-amber-400 rounded-full p-4 shadow-2xl transition-all hover:scale-105 z-40 flex items-center gap-2 border-2 border-amber-500/50">
            <span class="text-2xl">âœ¨</span>
            <span class="font-bold text-sm hidden md:inline">AI å»£å³¶åš®å°</span>
        </button>

        <!-- AI Chat Modal -->
        <div id="ai-chat-modal" class="fixed bottom-20 right-6 w-[90vw] md:w-[400px] h-[500px] bg-white rounded-2xl shadow-2xl z-50 flex flex-col hidden border border-stone-200 transition-all transform origin-bottom-right">
            <!-- Modal Header -->
            <div class="bg-stone-800 text-stone-100 p-4 rounded-t-2xl flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <span class="text-xl">âœ¨</span>
                    <h3 class="font-bold">AI æ—…éŠå°å¹«æ‰‹</h3>
                </div>
                <button onclick="toggleAIChat()" class="text-stone-400 hover:text-white">âœ•</button>
            </div>
            
            <!-- Chat History -->
            <div id="chat-history" class="flex-grow overflow-y-auto p-4 bg-stone-50 flex flex-col gap-2">
                <div class="ai-msg chat-bubble">
                    <p>ä½ å¥½ï¼æˆ‘æ˜¯ä½ å€‘çš„å»£å³¶æ—…éŠ AI åŠ©ç† ğŸ¤–ã€‚</p>
                    <p>æˆ‘å¯ä»¥å”åŠ©ä½ å€‘æŸ¥è©¢æ™¯é»ã€å°‹æ‰¾ç¾é£Ÿã€æˆ–æ˜¯ç¿»è­¯ç°¡å–®çš„æ—¥æ–‡ã€‚æœ‰ä»€éº¼æˆ‘å¯ä»¥å¹«å¿™çš„å—ï¼Ÿ</p>
                </div>
                <!-- Suggested Prompts -->
                <div class="flex flex-wrap gap-2 mt-2">
                    <button onclick="sendPrompt('æ¨è–¦çµ¦13æ­²ç”·ç”Ÿçš„å»£å³¶éš±è—æ™¯é»')" class="text-xs bg-white border border-stone-200 px-2 py-1 rounded-full hover:bg-amber-50 hover:border-amber-300 text-stone-600 transition-colors">ğŸ‘¦ 13æ­²ç”·ç”Ÿæ™¯é»</button>
                    <button onclick="sendPrompt('å»£å³¶ç‡’æ€éº¼é»é¤ï¼Ÿå¹«æˆ‘ç¿»è­¯')" class="text-xs bg-white border border-stone-200 px-2 py-1 rounded-full hover:bg-amber-50 hover:border-amber-300 text-stone-600 transition-colors">ğŸ—£ï¸ å»£å³¶ç‡’é»é¤æ—¥èª</button>
                    <button onclick="sendPrompt('é™„è¿‘çš„åœè»Šå ´æ€éº¼æ‰¾ï¼Ÿ')" class="text-xs bg-white border border-stone-200 px-2 py-1 rounded-full hover:bg-amber-50 hover:border-amber-300 text-stone-600 transition-colors">ğŸ…¿ï¸ å°‹æ‰¾åœè»Šå ´</button>
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-3 border-t border-stone-200 bg-white rounded-b-2xl">
                <div class="flex gap-2">
                    <input type="text" id="chat-input" placeholder="è¼¸å…¥å•é¡Œ..." class="flex-grow px-4 py-2 bg-stone-100 rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-amber-500" onkeypress="handleKeyPress(event)">
                    <button onclick="handleUserSend()" class="bg-amber-600 hover:bg-amber-700 text-white p-2 rounded-full w-10 h-10 flex items-center justify-center transition-colors">
                        â¤
                    </button>
                </div>
            </div>
        </div>
        
        <footer class="bg-stone-100 p-4 text-center text-xs text-stone-500 border-t border-stone-200">
            å»£å³¶è‡ªé§•éŠè¨ˆç•« | 12/26 - 12/31 | Powered by Gemini AI âœ¨
        </footer>
    </div>

    <script>
        // --- Data Source with LocalStorage persistence ---
        
        const defaultTripData = {
            days: [
                {
                    date: "12/26 (äº”)",
                    title: "æŠµé” & ç¾é£Ÿé¦–è¡",
                    icon: "ğŸ›¬",
                    color: "border-stone-400",
                    summary: "æ©Ÿå ´å–è»Šï¼Œå¸‚å€æ¼«æ­¥ï¼Œå»£å³¶ç‡’æ™šé¤ã€‚",
                    activities: [
                        { time: "ä¸‹åˆ", title: "æŠµé”å»£å³¶æ©Ÿå ´ & ç§Ÿè»Š", tag: "äº¤é€š", desc: "å‰å¾€å¸‚å€ç´„50åˆ†é˜ã€‚å…ˆåœ¨é£¯åº—é™„è¿‘æ‰¾å¥½æ”¶è²»åœè»Šå ´ã€‚", icon: "ğŸš—" },
                        { time: "å‚æ™š", title: "b hotel Check-in", tag: "ä½å®¿", desc: "å…¥ä½ b hotel ã‚¢ãƒ¼ãƒ„åœŸæ©‹ï¼Œç¨ä½œä¼‘æ¯ã€‚", icon: "ğŸ¨" },
                        { time: "æ™šä¸Š", title: "æœ¬é€šå•†åº—è¡—", tag: "è³¼ç‰©", role: "mom", desc: "è—¥å¦åº—ã€å”å‰è¨¶å¾·æ¡è²·ã€‚", icon: "ğŸ›ï¸" },
                        { time: "æ™šé¤", title: "å»£å³¶ç‡’ (Okonomiyaki)", tag: "ç¾é£Ÿ", role: "dad", desc: "æ¨è–¦ã€Œã¿ã£ã¡ã‚ƒã‚“ç·æœ¬åº—ã€æˆ–ã€ŒãŠå¥½ã¿æ‘ã€ã€‚", icon: "ğŸ³" }
                    ]
                },
                {
                    date: "12/27 (å…­)",
                    title: "è‰¦éšŠèˆ‡æµ·è»å’–å“©",
                    icon: "âš“",
                    color: "border-sky-500",
                    summary: "å³å¸‚ä¸€æ—¥éŠï¼šæ½›æ°´è‰‡ã€åšç‰©é¤¨ã€æµ·è»ç¾é£Ÿã€‚",
                    activities: [
                        { time: "ä¸Šåˆ", title: "å‰å¾€å³å¸‚ (Kure)", tag: "äº¤é€š", desc: "è»Šç¨‹ç´„40åˆ†é˜ã€‚", icon: "ğŸš—" },
                        { time: "æ™¯é»", title: "æµ·ä¸Šè‡ªè¡›éšŠå³å²æ–™é¤¨ (éµé¯¨é¤¨)", tag: "å†’éšª", role: "boy", desc: "é€²å…¥å·¨å¤§é€€å½¹æ½›æ°´è‰‡å…§éƒ¨åƒè§€ï¼Œçœ‹æ½›æœ›é¡ï¼", icon: "ğŸš¢" },
                        { time: "æ™¯é»", title: "å¤§å’Œåšç‰©é¤¨ (è¡›æ˜Ÿå±•é¤¨)", tag: "æ­·å²", desc: "æœ¬é¤¨æ•´ä¿®ä¸­ï¼Œåƒè§€è¡›æ˜Ÿé¤¨èˆ‡è³¼è²·ç´€å¿µå“ã€‚", icon: "ğŸ›ï¸" },
                        { time: "åˆé¤", title: "å³å¸‚æµ·è»å’–å“©", tag: "ç¾é£Ÿ", role: "dad", desc: "é«”é©—åƒæ½›è‰‡å…§çš„éµç›¤å’–å“©é£¯ã€‚", icon: "ğŸ›" },
                        { time: "ä¸‹åˆ", title: "ã‚¢ãƒ¬ã‚¤ã‹ã‚‰ã™ã“ã˜ã¾å…¬åœ’", tag: "å†’éšª", role: "boy", desc: "è¿‘è·é›¢è§€çœ‹ç¾å½¹æ½›æ°´è‰‡åœæ³Šã€‚", icon: "ğŸ“¸" }
                    ]
                },
                {
                    date: "12/28 (æ—¥)",
                    title: "äº¤é€šç§‘å­¸èˆ‡è³¼ç‰©",
                    icon: "ğŸï¸",
                    color: "border-rose-400",
                    summary: "äº¤é€šåšç‰©é¤¨æ¨¡å‹èˆ‡Outletå¤§å‹è³¼ç‰©ã€‚",
                    activities: [
                        { time: "ä¸Šåˆ", title: "Numaji äº¤é€šç§‘å­¸åšç‰©é¤¨", tag: "å†’éšª", role: "boy", desc: "å¤§é‡è»Šè¼›æ¨¡å‹ã€æˆ¶å¤–è®Šå½¢è…³è¸è»Šã€‚(è¶ä¼‘é¤¨æ—¥å‰åƒè§€)", icon: "ğŸš†" },
                        { time: "åˆé¤", title: "Outlet ç¾é£Ÿè¡—", tag: "ç¾é£Ÿ", desc: "ç°¡å–®è§£æ±ºï¼Œçˆ­å–é€›è¡—æ™‚é–“ã€‚", icon: "ğŸœ" },
                        { time: "ä¸‹åˆ", title: "THE OUTLETS HIROSHIMA", tag: "è³¼ç‰©", role: "mom", desc: "å»£å³¶æœ€å¤§Outletã€‚æœ‰æºœå†°å ´ã€ä¿é½¡çƒä¾›çˆ¸çˆ¸å°å­©ç©æ¨‚ã€‚", icon: "ğŸ›’" },
                        { time: "æ™šé¤", title: "å»£å³¶æ²¾éºµ (Tsukemen)", tag: "ç¾é£Ÿ", role: "dad", desc: "Outletå…§æˆ–å›å¸‚å€åƒï¼Œå–œæ„›è¾£å‘³å¿…è©¦ã€‚", icon: "ğŸŒ¶ï¸" }
                    ]
                },
                {
                    date: "12/29 (ä¸€)",
                    title: "å®®å³¶ä¸–ç•Œéºç”¢",
                    icon: "â›©ï¸",
                    color: "border-amber-500",
                    summary: "æ¸¡è¼ªã€ç¥ç¤¾ã€æ°´æ—é¤¨ã€ç‰¡è £å…¨é¤ã€‚",
                    activities: [
                        { time: "ä¸Šåˆ", title: "æ­æ¸¡è¼ªå‰å¾€å®®å³¶", tag: "äº¤é€š", desc: "å®®å³¶å£åœè»Šï¼Œæ­èˆ¹é«”é©—æµ·ä¸Šçœ‹å¤§é³¥å±…ã€‚", icon: "â›´ï¸" },
                        { time: "æ™¯é»", title: "åš´å³¶ç¥ç¤¾", tag: "æ–‡åŒ–", desc: "é€€æ½®æ™‚å¯èµ°åˆ°å¤§é³¥å±…é™„è¿‘ã€‚", icon: "â›©ï¸" },
                        { time: "åˆé¤", title: "ç‰¡è £å±‹ & ç©´å­é£¯", tag: "ç¾é£Ÿ", role: "dad", desc: "å¿…åƒçƒ¤è ”èˆ‡æ˜Ÿé°»é£¯ä¾¿ç•¶ã€‚", icon: "ğŸ±" },
                        { time: "æ™¯é»", title: "å®®å³¶æ°´æ—é¤¨", tag: "è‡ªç„¶", role: "boy", desc: "çœ‹ç€¨æˆ¶å…§æµ·ç”Ÿç‰©èˆ‡å¯æ„›æ±Ÿè±šã€‚", icon: "ğŸ¬" },
                        { time: "é»å¿ƒ", title: "ç‚¸ç´…è‘‰é¥…é ­", tag: "ç¾é£Ÿ", role: "mom", desc: "è¡¨åƒé“å•†åº—è¡—å¿…åƒç”œé»ã€‚", icon: "ğŸ" }
                    ]
                },
                {
                    date: "12/30 (äºŒ)",
                    title: "é‡£é­šé«”é©— & è ”å°å±‹",
                    icon: "ğŸ£",
                    color: "border-emerald-500",
                    summary: "å±±ä¸­é‡£é­šè¶£ï¼Œæµ·é‚ŠéŠæ¨‚åœ’ï¼Œç‚­çƒ¤ç‰¡è £æ™šé¤ã€‚",
                    activities: [
                        { time: "ä¸Šåˆ", title: "æ¹¯ä¾†é‡£é­šæ± ", tag: "é«”é©—", role: "boy", desc: "å®‰å…¨å¥½é‡£çš„è™¹é±’é­šï¼Œç¾å ´é¹½çƒ¤è¶…æœ‰æˆå°±æ„Ÿã€‚", icon: "ğŸ£" },
                        { time: "ä¸‹åˆ", title: "Marina Hop", tag: "ä¼‘é–’", desc: "æµ·é‚Šå°å‹éŠæ¨‚åœ’å€+è³¼ç‰©ä¸­å¿ƒã€‚", icon: "ğŸ¡" },
                        { time: "æ™šé¤", title: "å»£å³¶è ”å°å±‹ (Kakigoya)", tag: "ç¾é£Ÿ", role: "dad", desc: "å®‡å“æµ·å²¸ç‚­çƒ¤å¸¶æ®¼ç‰¡è £ï¼Œæ°£æ°›ä½³ã€‚", icon: "ğŸ”¥" }
                    ]
                },
                {
                    date: "12/31 (ä¸‰)",
                    title: "æœ€å¾Œå·¡ç¦® & è¿”ç¨‹",
                    icon: "ğŸ›«",
                    color: "border-stone-600",
                    summary: "å¹³å’Œå…¬åœ’æ•£æ­¥ï¼Œæœ€å¾Œè£œè²¨ï¼Œå‰å¾€æ©Ÿå ´ã€‚",
                    activities: [
                        { time: "ä¸Šåˆ", title: "å¹³å’Œç´€å¿µå…¬åœ’", tag: "æ–‡åŒ–", desc: "åŸçˆ†åœ“é ‚é¤¨ï¼Œæ„Ÿå—æ­·å²æ°›åœã€‚", icon: "ğŸ•Šï¸" },
                        { time: "ä¸­åˆ", title: "å¸‚å€æœ€å¾Œè³¼ç‰©", tag: "è³¼ç‰©", role: "mom", desc: "SOGO/Parco/Donkiã€‚æ³¨æ„é™¤å¤•18:00ææ—©æ‰“çƒŠã€‚", icon: "ğŸ›ï¸" },
                        { time: "ä¸‹åˆ", title: "å‰å¾€å»£å³¶æ©Ÿå ´", tag: "äº¤é€š", desc: "é‚„è»Šï¼Œæ­æ©Ÿè¿”å®¶ã€‚å†è¦‹å»£å³¶ï¼", icon: "âœˆï¸" }
                    ]
                }
            ],
            foodList: [
                { name: "å»£å³¶ç‡’", note: "å¿…åŠ ç¾ä¹ƒæ»‹èˆ‡å¤§é‡é’è”¥", icon: "ğŸ³" },
                { name: "å»£å³¶ç‰¡è £", note: "çƒ¤çš„ã€ç‚¸çš„éƒ½è¦è©¦", icon: "ğŸ¦ª" },
                { name: "ç©´å­é£¯", note: "å®®å³¶åç‰©ï¼Œæ˜Ÿé°»ä¾¿ç•¶", icon: "ğŸ±" },
                { name: "ç‚¸ç´…è‘‰é¥…é ­", note: "å¤–é…¥å…§è»Ÿç”œé»", icon: "ğŸ" },
                { name: "æµ·è»å’–å“©", note: "å³å¸‚ç‰¹è‰²ï¼Œé‡‘å±¬ç›¤è£", icon: "ğŸ›" },
                { name: "å»£å³¶æ²¾éºµ", note: "è¾›è¾£å†·éºµï¼Œå¾ˆé–‹èƒƒ", icon: "ğŸœ" },
                { name: "é¹½çƒ¤è™¹é±’", note: "è‡ªé‡£è‡ªåƒæœ€ç¾å‘³", icon: "ğŸŸ" }
            ]
        };

        // Load data from LocalStorage or use default
        let tripData;
        const storedData = localStorage.getItem('hiroshimaTripData_v2');
        if (storedData) {
            tripData = JSON.parse(storedData);
        } else {
            tripData = JSON.parse(JSON.stringify(defaultTripData)); // Deep copy
        }

        let currentDayIndex = 0;
        let isEditMode = false;

        // --- Core Functions ---

        function initApp() {
            renderDaySelector();
            renderDayDetails(0);
            renderFoodList();
            initCharts();
        }

        // Save to local storage
        function saveData() {
            localStorage.setItem('hiroshimaTripData_v2', JSON.stringify(tripData));
            initCharts(); // Update charts to reflect changes
        }

        function resetData() {
            if(confirm("ç¢ºå®šè¦é‡ç½®æ‰€æœ‰è¡Œç¨‹å›åˆ°é è¨­å€¼å—ï¼Ÿæ‰€æœ‰çš„ä¿®æ”¹éƒ½æœƒéºå¤±ã€‚")) {
                localStorage.removeItem('hiroshimaTripData_v2');
                location.reload();
            }
        }

        function switchTab(tabName) {
            if (isEditMode && tabName !== 'itinerary') {
                alert("è«‹å…ˆå„²å­˜æˆ–å–æ¶ˆç·¨è¼¯æ¨¡å¼");
                return;
            }
            // Hide all views
            ['itinerary', 'analysis', 'food', 'tips'].forEach(id => {
                document.getElementById(`view-${id}`).classList.add('hidden');
                document.getElementById(`tab-${id}`).classList.remove('btn-active');
                document.getElementById(`tab-${id}`).classList.remove('border-amber-600');
            });

            // Show selected view
            const selectedView = document.getElementById(`view-${tabName}`);
            selectedView.classList.remove('hidden');
            selectedView.classList.add('fade-in');

            // Style active tab
            const activeTab = document.getElementById(`tab-${tabName}`);
            activeTab.classList.add('btn-active');
            activeTab.classList.add('border-amber-600');
        }

        // --- Itinerary Logic ---

        function renderDaySelector() {
            const container = document.getElementById('day-selector');
            container.innerHTML = tripData.days.map((day, index) => `
                <button onclick="selectDay(${index})" 
                        id="day-btn-${index}"
                        class="day-btn flex-shrink-0 w-24 md:w-32 p-3 rounded-lg border-2 ${index === 0 ? 'border-amber-500 bg-amber-50' : 'border-stone-200 bg-white'} hover:border-amber-300 transition-all text-left group">
                    <div class="text-xs text-stone-400 font-bold">${day.date}</div>
                    <div class="text-2xl mt-1 group-hover:scale-110 transition-transform">${day.icon}</div>
                    <div class="text-xs text-stone-600 mt-1 truncate font-medium">${day.title.split('&')[0]}</div>
                </button>
            `).join('');
        }

        function selectDay(index) {
            if (isEditMode) {
                if(!confirm("æ­£åœ¨ç·¨è¼¯ä¸­ï¼Œåˆ‡æ›æ—¥æœŸå°‡è‡ªå‹•å„²å­˜ç•¶å‰ä¿®æ”¹ï¼Œç¢ºå®šå—ï¼Ÿ")) return;
                saveItinerary(); // Auto save
            }
            
            currentDayIndex = index;
            // Update buttons style
            const buttons = document.querySelectorAll('.day-btn');
            buttons.forEach((btn, idx) => {
                if (idx === index) {
                    btn.classList.remove('border-stone-200', 'bg-white');
                    btn.classList.add('border-amber-500', 'bg-amber-50');
                } else {
                    btn.classList.add('border-stone-200', 'bg-white');
                    btn.classList.remove('border-amber-500', 'bg-amber-50');
                }
            });
            renderDayDetails(index);
        }

        function toggleEditMode() {
            isEditMode = !isEditMode;
            const btn = document.getElementById('edit-toggle-btn');
            
            if (isEditMode) {
                btn.innerHTML = 'ğŸ’¾ å„²å­˜ä¿®æ”¹';
                btn.classList.remove('bg-stone-100', 'text-stone-600');
                btn.classList.add('bg-amber-600', 'text-white', 'border-amber-600');
            } else {
                saveItinerary(); // Save when toggling off
                btn.innerHTML = 'âœï¸ ç·¨è¼¯è¡Œç¨‹';
                btn.classList.add('bg-stone-100', 'text-stone-600');
                btn.classList.remove('bg-amber-600', 'text-white', 'border-amber-600');
            }
            renderDayDetails(currentDayIndex);
        }

        function saveItinerary() {
            if (!isEditMode) return; // Already saved or not in edit mode
            
            // Collect data from inputs
            const dayContainer = document.getElementById('day-details-container');
            const activityDivs = dayContainer.querySelectorAll('.activity-card');
            
            const newActivities = [];
            activityDivs.forEach(div => {
                const time = div.querySelector('.input-time').value;
                const tag = div.querySelector('.input-tag').value;
                const role = div.querySelector('.input-role').value;
                const icon = div.querySelector('.input-icon').value;
                const title = div.querySelector('.input-title').value;
                const desc = div.querySelector('.input-desc').value;
                
                newActivities.push({ time, tag, role, icon, title, desc });
            });
            
            tripData.days[currentDayIndex].activities = newActivities;
            saveData();
        }

        function addActivity() {
            tripData.days[currentDayIndex].activities.push({
                time: "æ™‚é–“",
                title: "æ–°æ´»å‹•",
                tag: "ä¸€èˆ¬",
                role: "",
                desc: "è«‹è¼¸å…¥æ´»å‹•æè¿°",
                icon: "ğŸ“"
            });
            renderDayDetails(currentDayIndex);
        }

        function deleteActivity(actIndex) {
            if(confirm("ç¢ºå®šåˆªé™¤æ­¤æ´»å‹•ï¼Ÿ")) {
                tripData.days[currentDayIndex].activities.splice(actIndex, 1);
                renderDayDetails(currentDayIndex);
            }
        }

        function renderDayDetails(index) {
            const day = tripData.days[index];
            const container = document.getElementById('day-details-container');
            
            // --- READ MODE ---
            if (!isEditMode) {
                const activitiesHtml = day.activities.map(act => {
                    let roleBadge = '';
                    let borderClass = 'border-l-4 border-stone-200';
                    
                    if (act.role === 'boy') {
                        roleBadge = '<span class="ml-2 bg-sky-100 text-sky-700 text-xs px-2 py-0.5 rounded-full font-bold">ğŸ‘¦ ç”·å­©</span>';
                        borderClass = 'border-l-4 border-sky-400';
                    } else if (act.role === 'mom') {
                        roleBadge = '<span class="ml-2 bg-rose-100 text-rose-700 text-xs px-2 py-0.5 rounded-full font-bold">ğŸ‘© åª½åª½</span>';
                        borderClass = 'border-l-4 border-rose-400';
                    } else if (act.role === 'dad') {
                        roleBadge = '<span class="ml-2 bg-amber-100 text-amber-700 text-xs px-2 py-0.5 rounded-full font-bold">ğŸ‘¨ çˆ¸çˆ¸</span>';
                        borderClass = 'border-l-4 border-amber-400';
                    }

                    return `
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-stone-100 ${borderClass} hover:shadow-md transition-shadow">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span class="font-mono text-stone-400 text-sm font-bold bg-stone-100 px-2 rounded">${act.time}</span>
                                <span class="text-sm text-stone-400">|</span>
                                <span class="text-stone-500 text-xs border border-stone-200 px-1 rounded">${act.tag}</span>
                                ${roleBadge}
                            </div>
                            <span class="text-2xl">${act.icon}</span>
                        </div>
                        <h3 class="text-lg font-bold text-stone-800">${act.title}</h3>
                        <p class="text-stone-600 mt-1 text-sm">${act.desc}</p>
                    </div>
                    `;
                }).join('');

                container.innerHTML = `
                    <div class="bg-stone-100 p-4 rounded-lg mb-4 text-center border border-stone-200">
                        <h2 class="text-xl font-bold text-stone-700">${day.date} ${day.title}</h2>
                        <p class="text-stone-500 text-sm mt-1">${day.summary}</p>
                    </div>
                    <div class="space-y-3 fade-in">
                        ${activitiesHtml}
                    </div>
                `;
            } 
            // --- EDIT MODE ---
            else {
                const activitiesHtml = day.activities.map((act, idx) => `
                <div class="activity-card bg-white p-4 rounded-lg shadow-md border-2 border-amber-100 mb-4 relative">
                    <button onclick="deleteActivity(${idx})" class="absolute top-2 right-2 text-stone-300 hover:text-red-500">ğŸ—‘ï¸</button>
                    
                    <div class="grid grid-cols-4 gap-2 mb-2">
                        <div class="col-span-1">
                            <label class="text-xs text-stone-400">æ™‚é–“</label>
                            <input type="text" class="input-time edit-input" value="${act.time}">
                        </div>
                        <div class="col-span-1">
                            <label class="text-xs text-stone-400">Icon</label>
                            <input type="text" class="input-icon edit-input" value="${act.icon}">
                        </div>
                        <div class="col-span-1">
                            <label class="text-xs text-stone-400">æ¨™ç±¤</label>
                            <input type="text" class="input-tag edit-input" value="${act.tag}">
                        </div>
                        <div class="col-span-1">
                            <label class="text-xs text-stone-400">è§’è‰²</label>
                            <select class="input-role edit-input bg-white">
                                <option value="" ${act.role===''?'selected':''}>ä¸€èˆ¬</option>
                                <option value="boy" ${act.role==='boy'?'selected':''}>ğŸ‘¦ ç”·å­©</option>
                                <option value="mom" ${act.role==='mom'?'selected':''}>ğŸ‘© åª½åª½</option>
                                <option value="dad" ${act.role==='dad'?'selected':''}>ğŸ‘¨ çˆ¸çˆ¸</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-2">
                         <label class="text-xs text-stone-400">æ¨™é¡Œ</label>
                         <input type="text" class="input-title edit-input font-bold" value="${act.title}">
                    </div>
                    
                    <div>
                         <label class="text-xs text-stone-400">æè¿°</label>
                         <textarea class="input-desc edit-input h-16 resize-none">${act.desc}</textarea>
                    </div>
                </div>
                `).join('');

                container.innerHTML = `
                    <div class="bg-amber-50 p-3 rounded mb-4 text-center border border-amber-200 text-amber-800 text-sm">
                        æ­£åœ¨ç·¨è¼¯: ${day.date} (é»æ“Šä¸Šæ–¹ã€ŒğŸ’¾ å„²å­˜ã€å®Œæˆ)
                    </div>
                    <div class="space-y-4">
                        ${activitiesHtml}
                        <button onclick="addActivity()" class="w-full py-3 border-2 border-dashed border-stone-300 text-stone-400 rounded-lg hover:border-amber-400 hover:text-amber-500 transition-colors font-bold">
                            â• æ–°å¢æ´»å‹•
                        </button>
                    </div>
                `;
            }
        }

        function renderFoodList() {
            const container = document.getElementById('food-list-container');
            container.innerHTML = tripData.foodList.map((item, idx) => `
                <div class="bg-white p-4 rounded-lg shadow-sm border border-stone-100 flex items-center justify-between cursor-pointer group" onclick="toggleFood(this)">
                    <div class="flex items-center gap-4">
                        <div class="bg-amber-50 p-3 rounded-full text-2xl group-hover:bg-amber-100 transition-colors">${item.icon}</div>
                        <div>
                            <h3 class="font-bold text-stone-800 line-through-target">${item.name}</h3>
                            <p class="text-xs text-stone-500">${item.note}</p>
                        </div>
                    </div>
                    <div class="w-6 h-6 rounded-full border-2 border-stone-300 flex items-center justify-center check-circle">
                        <div class="w-3 h-3 bg-emerald-500 rounded-full hidden check-dot"></div>
                    </div>
                </div>
            `).join('');
        }

        function toggleFood(el) {
            el.querySelector('.check-dot').classList.toggle('hidden');
            el.querySelector('.line-through-target').classList.toggle('line-through');
            el.querySelector('.line-through-target').classList.toggle('text-stone-400');
            el.classList.toggle('bg-stone-50');
        }

        // --- Chart Initialization ---

        function initCharts() {
            // Recalculate weights based on current tripData (Simple Logic)
            let scores = { dad: 0, mom: 0, boy: 0, culture: 0, nature: 0 };
            
            tripData.days.forEach(day => {
                day.activities.forEach(act => {
                    if(act.role === 'dad') scores.dad += 2;
                    else if(act.role === 'mom') scores.mom += 2;
                    else if(act.role === 'boy') scores.boy += 2;
                    
                    if(act.tag === 'æ–‡åŒ–' || act.tag === 'æ­·å²') scores.culture += 1.5;
                    if(act.tag === 'è‡ªç„¶' || act.tag === 'é‡£é­š') scores.nature += 1.5;
                });
            });

            // Fallback defaults to avoid empty chart
            const dataValues = [
                Math.max(4, scores.dad), 
                Math.max(4, scores.mom), 
                Math.max(4, scores.boy), 
                Math.max(3, scores.culture), 
                Math.max(3, scores.nature)
            ];

            // Radar Chart
            const ctxRadar = document.getElementById('interestChart').getContext('2d');
            
            // Destroy existing if any (simplest way for vanilla JS reload)
            if(window.myRadarChart) window.myRadarChart.destroy();

            window.myRadarChart = new Chart(ctxRadar, {
                type: 'radar',
                data: {
                    labels: ['ç¾é£Ÿ (çˆ¸çˆ¸)', 'è³¼ç‰© (åª½åª½)', 'å†’éšª (ç”·å­©)', 'æ–‡åŒ– (æ•™è‚²)', 'è‡ªç„¶ (æ”¾é¬†)'],
                    datasets: [{
                        label: 'è¡Œç¨‹æ¬Šé‡åˆ†ä½ˆ',
                        data: dataValues, 
                        backgroundColor: 'rgba(217, 119, 6, 0.2)', 
                        borderColor: 'rgba(217, 119, 6, 1)',
                        pointBackgroundColor: 'rgba(217, 119, 6, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(217, 119, 6, 1)'
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: { color: '#e5e7eb' },
                            grid: { color: '#e5e7eb' },
                            pointLabels: {
                                font: { size: 12, family: "'Noto Sans TC', sans-serif" },
                                color: '#44403c' 
                            },
                            suggestedMin: 0,
                            suggestedMax: 10
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });

            // Doughnut Chart (Static for demo mostly, but could be dynamic similarly)
            const ctxDoughnut = document.getElementById('activityChart').getContext('2d');
             if(window.myDoughnutChart) window.myDoughnutChart.destroy();

            window.myDoughnutChart = new Chart(ctxDoughnut, {
                type: 'doughnut',
                data: {
                    labels: ['æ™¯é»/é«”é©—', 'ç¾é£Ÿ/ç”¨é¤', 'è³¼ç‰©', 'äº¤é€š/ç§»å‹•'],
                    datasets: [{
                        data: [35, 25, 20, 20],
                        backgroundColor: ['#38bdf8', '#fbbf24', '#fb7185', '#a8a29e'],
                        borderWidth: 0
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: { family: "'Noto Sans TC', sans-serif" },
                                color: '#57534e'
                            }
                        }
                    }
                }
            });
        }

        // --- AI Assistant Logic (Gemini API) ---

        const apiKey = ""; // Runtime provided
        const chatModal = document.getElementById('ai-chat-modal');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        
        // Toggle Chat Modal
        function toggleAIChat() {
            chatModal.classList.toggle('hidden');
        }
        
        // Specific trigger (opens chat and auto-sends prompt)
        function triggerAIChat(prompt) {
            chatModal.classList.remove('hidden');
            sendPrompt(prompt);
        }

        // Handle Enter key
        function handleKeyPress(e) {
            if (e.key === 'Enter') handleUserSend();
        }

        // Handle User Send
        function handleUserSend() {
            const text = chatInput.value.trim();
            if (!text) return;
            sendPrompt(text);
            chatInput.value = '';
        }

        // Core Send Logic
        async function sendPrompt(text) {
            // Add User Message
            appendMessage(text, 'user');
            
            // Show Loading
            const loadingId = appendLoading();
            
            try {
                const responseText = await callGeminiAPI(text);
                removeMessage(loadingId);
                appendMessage(responseText, 'ai');
            } catch (error) {
                removeMessage(loadingId);
                appendMessage("æŠ±æ­‰ï¼Œç›®å‰é€£ç·šä¸ç©©ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚", 'ai');
                console.error(error);
            }
        }

        function appendMessage(text, sender) {
            const div = document.createElement('div');
            div.className = `chat-bubble ${sender === 'user' ? 'user-msg' : 'ai-msg'}`;
            if (sender === 'ai') {
                div.innerHTML = marked.parse(text); // Use Markdown for AI
            } else {
                div.textContent = text;
            }
            chatHistory.appendChild(div);
            chatHistory.scrollTop = chatHistory.scrollHeight;
            return div.id;
        }

        function appendLoading() {
            const id = 'loading-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = 'chat-bubble ai-msg';
            div.innerHTML = '<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>';
            chatHistory.appendChild(div);
            chatHistory.scrollTop = chatHistory.scrollHeight;
            return id;
        }

        function removeMessage(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        // API Call with Backoff
        async function callGeminiAPI(userQuery) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const systemPrompt = "ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„å»£å³¶æ—…éŠå°éŠï¼Œå°ˆé–€å”åŠ©å¸¶æœ‰9æ­²å’Œ13æ­²ç”·å­©çš„å®¶åº­ã€‚ä½ éå¸¸äº†è§£å»£å³¶ç‡’ã€ç‰¡è £ã€å³å¸‚æµ·è»æ­·å²ä»¥åŠé©åˆè‡ªé§•éŠçš„æ™¯é»ã€‚è«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”ï¼Œèªæ°£è¦ªåˆ‡ç†±æƒ…ï¼Œå›ç­”ç›¡é‡ç°¡æ½”å¯¦ç”¨ã€‚";
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };

            const maxRetries = 5;
            let attempt = 0;
            
            while (attempt < maxRetries) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`API Error: ${response.status}`);

                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "ç„¡æ³•å–å¾—å›æ‡‰ã€‚";
                } catch (error) {
                    attempt++;
                    if (attempt >= maxRetries) throw error;
                    await new Promise(r => setTimeout(r, Math.pow(2, attempt) * 1000));
                }
            }
        }

        // Start App
        window.addEventListener('DOMContentLoaded', initApp);

    </script>
</body>
</html>